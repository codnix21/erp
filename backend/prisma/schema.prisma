// Prisma Schema для ERP-системы
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Аутентификация и авторизация
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  firstName     String?  @map("first_name")
  lastName      String?  @map("last_name")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  userCompanyRoles UserCompanyRole[]
  refreshTokens    RefreshToken[]
  auditLogs        AuditLog[]
  createdOrders    Order[]          @relation("OrderCreator")
  createdPayments  Payment[]        @relation("PaymentCreator")
  stockMovements   StockMovement[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique // Admin, Manager, Accountant, Warehouse
  permissions Json     // Массив разрешений
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  userCompanyRoles UserCompanyRole[]

  @@map("roles")
}

model UserCompanyRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  companyId String   @map("company_id")
  roleId    String   @map("role_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  role    Role    @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId, roleId])
  @@index([userId, companyId, isActive])
  @@map("user_company_roles")
}

// ============================================
// Компании (Multi-tenant)
// ============================================

model Company {
  id             String   @id @default(uuid())
  name           String
  inn            String?  @unique
  address        String?
  phone          String?
  email          String?
  defaultCurrency String  @default("RUB") @map("default_currency")
  taxRate        Decimal  @default(20) @map("tax_rate") // НДС по умолчанию
  settings       Json?    // Дополнительные настройки
  isActive       Boolean  @default(true) @map("is_active")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  userCompanyRoles UserCompanyRole[]
  categories       Category[]
  products         Product[]
  customers        Customer[]
  suppliers        Supplier[]
  orders           Order[]
  invoices         Invoice[]
  payments         Payment[]
  warehouses       Warehouse[]
  stockMovements   StockMovement[]
  auditLogs        AuditLog[]

  @@map("companies")
}

// ============================================
// Товары и услуги
// ============================================

model Category {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  name        String
  description String?
  parentId    String?  @map("parent_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  company  Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  products Product[]
  parent   Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  @@map("categories")
}

model Product {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  name        String
  sku         String?  // Артикул
  description String?
  categoryId  String?  @map("category_id")
  unit        String   @default("шт") // Единица измерения
  price       Decimal  @default(0)
  currency    String   @default("RUB")
  taxRate     Decimal  @default(20) @map("tax_rate") // НДС
  isService   Boolean  @default(false) @map("is_service")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  category      Category?      @relation(fields: [categoryId], references: [id])
  orderItems    OrderItem[]
  stockMovements StockMovement[]

  @@unique([companyId, sku])
  @@index([companyId, categoryId])
  @@map("products")
}

// ============================================
// Клиенты и поставщики
// ============================================

model Customer {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  name        String
  email       String?
  phone       String?
  address     String?
  taxId       String?  @map("tax_id") // ИНН
  notes       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orders  Order[]

  @@index([companyId])
  @@map("customers")
}

model Supplier {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  name        String
  email       String?
  phone       String?
  address     String?
  taxId       String?  @map("tax_id") // ИНН
  notes       String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  orders  Order[]

  @@index([companyId])
  @@map("suppliers")
}

// ============================================
// Заказы
// ============================================

model Order {
  id          String      @id @default(uuid())
  companyId   String      @map("company_id")
  customerId  String?     @map("customer_id")
  supplierId  String?     @map("supplier_id")
  orderNumber String      @unique @map("order_number")
  status      OrderStatus @default(DRAFT)
  totalAmount Decimal     @default(0) @map("total_amount")
  currency    String      @default("RUB")
  notes       String?
  dueDate     DateTime?   @map("due_date")
  createdById String      @map("created_by_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  company    Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  customer   Customer?   @relation(fields: [customerId], references: [id])
  supplier   Supplier?   @relation(fields: [supplierId], references: [id])
  createdBy  User        @relation("OrderCreator", fields: [createdById], references: [id])
  items      OrderItem[]
  invoices   Invoice[]

  @@index([companyId, status])
  @@index([companyId, customerId])
  @@index([companyId, supplierId])
  @@map("orders")
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model OrderItem {
  id        String   @id @default(uuid())
  orderId   String   @map("order_id")
  productId String   @map("product_id")
  quantity  Decimal
  price     Decimal
  taxRate   Decimal  @default(20) @map("tax_rate")
  total     Decimal  @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// ============================================
// Финансы
// ============================================

model Invoice {
  id           String        @id @default(uuid())
  companyId    String        @map("company_id")
  orderId      String?       @map("order_id")
  invoiceNumber String       @unique @map("invoice_number")
  status       InvoiceStatus @default(DRAFT)
  totalAmount  Decimal       @default(0) @map("total_amount")
  paidAmount   Decimal       @default(0) @map("paid_amount")
  currency     String        @default("RUB")
  taxAmount    Decimal       @default(0) @map("tax_amount")
  dueDate      DateTime?     @map("due_date")
  issuedDate   DateTime?     @map("issued_date")
  notes        String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")

  // Relations
  company  Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  order    Order?   @relation(fields: [orderId], references: [id])
  payments Payment[]

  @@index([companyId, status])
  @@index([companyId, invoiceNumber])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

model Payment {
  id            String        @id @default(uuid())
  companyId     String        @map("company_id")
  invoiceId     String?       @map("invoice_id")
  amount        Decimal
  currency      String        @default("RUB")
  paymentMethod PaymentMethod @map("payment_method")
  paymentDate   DateTime      @map("payment_date")
  reference     String?       // Номер платёжного документа
  notes         String?
  createdById   String        @map("created_by_id")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // Relations
  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice  Invoice? @relation(fields: [invoiceId], references: [id])
  createdBy User    @relation("PaymentCreator", fields: [createdById], references: [id])

  @@index([companyId, paymentDate])
  @@index([invoiceId])
  @@map("payments")
}

enum PaymentMethod {
  CASH
  BANK_TRANSFER
  CARD
  ELECTRONIC
  OTHER
}

// ============================================
// Склад
// ============================================

model Warehouse {
  id        String   @id @default(uuid())
  companyId String   @map("company_id")
  name      String
  address   String?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  company       Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)
  stockMovements StockMovement[]

  @@index([companyId])
  @@map("warehouses")
}

model StockMovement {
  id            String            @id @default(uuid())
  companyId     String            @map("company_id")
  warehouseId   String            @map("warehouse_id")
  productId     String            @map("product_id")
  movementType  StockMovementType @map("movement_type")
  quantity      Decimal
  referenceId   String?           @map("reference_id") // ID заказа, инвентаризации и т.д.
  referenceType String?           @map("reference_type") // ORDER, INVENTORY, ADJUSTMENT
  notes         String?
  createdById   String?           @map("created_by_id")
  createdAt     DateTime          @default(now()) @map("created_at")

  // Relations
  company  Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  warehouse Warehouse @relation(fields: [warehouseId], references: [id])
  product  Product   @relation(fields: [productId], references: [id])
  createdBy User?    @relation(fields: [createdById], references: [id], onDelete: SetNull)

  @@index([companyId, warehouseId, productId])
  @@index([companyId, movementType, createdAt])
  @@map("stock_movements")
}

enum StockMovementType {
  IN          // Приход
  OUT         // Расход
  TRANSFER    // Перемещение между складами
  ADJUSTMENT  // Корректировка (инвентаризация)
  RESERVED    // Резервирование
  UNRESERVED  // Снятие резерва
}

// ============================================
// Аудит и логи
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  companyId  String?  @map("company_id")
  userId     String?  @map("user_id")
  action     String   // CREATE, UPDATE, DELETE
  entityType String   @map("entity_type") // Product, Order, Invoice и т.д.
  entityId   String   @map("entity_id")
  oldValues  Json?    @map("old_values")
  newValues  Json?    @map("new_values")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  // Relations
  company Company? @relation(fields: [companyId], references: [id], onDelete: SetNull)
  user    User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([companyId, entityType, entityId])
  @@index([companyId, createdAt])
  @@index([userId, createdAt])
  @@map("audit_logs")
}

